name: Deploy RBAC Exercise

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - deploy
          - cleanup
          - status

jobs:
  manage-exercise:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Install oc CLI
      run: |
        wget -q https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz
        tar -xzf openshift-client-linux.tar.gz
        sudo mv oc /usr/local/bin/
    
    - name: Login to OpenShift
      run: |
        oc login --token=${{ secrets.OPENSHIFT_TOKEN }} \
                 --server=https://api.ocp4.example.com:6443
    
    - name: Deploy Exercise
      if: github.event.inputs.action == 'deploy'
      run: |
        echo "üöÄ Deploying RBAC Exercise..."
        oc apply -f D0280/exercise-rbac-ecommerce/manifests/
        
        echo "üîê Assigning anyuid SCC to ecommerce-prod-sa..."
        oc adm policy add-scc-to-user anyuid -z ecommerce-prod-sa -n ecommerce-prod
        
        echo "‚è≥ Waiting for deployments..."
        oc rollout status deployment/frontend -n ecommerce-prod --timeout=2m
        oc rollout status deployment/backend -n ecommerce-prod --timeout=2m
        
        echo "‚úÖ Deployment complete!"
        oc get all -n ecommerce-prod
        oc get groups
    
    - name: Show Status
      if: github.event.inputs.action == 'status'
      run: |
        echo "üìä Status:"
        oc get pods -n ecommerce-prod
        oc get groups
        oc get rolebindings -n ecommerce-prod
    
    - name: Cleanup Exercise
      if: github.event.inputs.action == 'cleanup'
      run: |
        echo "üßπ Cleaning up..."
        oc adm policy remove-scc-from-user anyuid -z ecommerce-prod-sa -n ecommerce-prod || true
        oc delete namespace ecommerce-prod --wait=false || true
        oc delete namespace ecommerce-dev --wait=false || true
        oc delete group production-admins || true
        oc delete group developers || true
        echo "‚úÖ Cleanup complete!"
